@page "/profiles"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.AspNetCore.Authorization
@using SSW.Rewards.Admin.Components
@using SSW.Rewards.Admin.Components.Dialogs.Profile
@using SSW.Rewards.Admin.Helpers
@using SSW.Rewards.Admin.Models.Interfaces

@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IStaffClient _client

@attribute [Authorize]

<MudText Typo="Typo.h2">Profiles</MudText>
<MudText Typo="Typo.body1">All staff profiles available for editing</MudText>

<MudPaper Class="pa-2" Elevation="0">
    <MudCheckBox T="bool" @bind-Checked="@ShowArchivedStaff" Label="Filter List for Archived Staff" />
</MudPaper>

<AdminTable Items="@(_profileItemsViewModels?.Cast<ITableItems>().OrderBy(i => i.Name).ToList())"
            Headings="@_headings"
            TableTitle="Profiles"
            SearchPlaceholderText="Search for a profile"
            IsLoading="@_loading"
            OnClick="@(OnRowClicked)"/>

@* TODO: Make this like current rewards (sticky to the bottom right with padding from the bottom of the table when scrolled to the bottom)   *@
<MudFab Class="sticky object-right-bottom" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@((e) => OpenDialog(_disableBackdropClick))"/>

@* TODO: Move this to the code behind *@
@code {
    readonly DialogOptions _disableBackdropClick = new DialogOptions() { DisableBackdropClick = true,  MaxWidth = MaxWidth.Medium, FullWidth = true };
    private bool _loading = true;
    private bool _showArchivedStaff = false;
    private bool ShowArchivedStaff
    {
        get => _showArchivedStaff;
        set
        {
            _showArchivedStaff = value;
            _profileItemsViewModels = _model?.Staff
                .Select(ProfileItemsViewModel.FromDto)
                .Where(x => x.IsDeleted == value)
                .ToList();
        }
    } 
    
    private StaffListViewModel? _model;

    private StaffListViewModel? Model
    {
        get => _model;
        set
        {
            _model = value;
            _profileItemsViewModels = _model?.Staff
                .Select(ProfileItemsViewModel.FromDto)
                .Where(x => !x.IsDeleted)
                .ToList();
            _loading = false;
        }
    }
    
    private List<ProfileItemsViewModel>? _profileItemsViewModels;
    
    private readonly List<TableHeaders> _headings = new()
    {
        new TableHeaders { Heading = "Name" },
        new TableHeaders { Heading = "Title" }
    };
    
    private void OnRowClicked(TableRowClickEventArgs<ITableItems> obj)
    {
        var item = _model?.Staff.FirstOrDefault(x => x.Id == obj.Item.Id);

        if (item != null) Navigation.NavigateTo($"/profile/{item.Id}");
    }

    private async Task OpenDialog(DialogOptions options)
    {
        var dialog = DialogService.Show<AddStaffProfileDialog>("Create a Staff Profile", options);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
    // Add the Reward
            if (result.Data is StaffDto dto)
            {
                await _client.UpsertStaffMemberProfileAsync(StaffHelper.FromDto(dto));
            }
            await GetStaff();
        }
    }


    protected override async Task OnInitializedAsync()
    {
        await GetStaff();

        await base.OnInitializedAsync();
    }

    private async Task GetStaff()
    {
        try
        {
            Model = await _client.GetAsync();
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
        catch (Exception ex)
        {
            //Log.
        }
    }

    public class ProfileItemsViewModel : ITableItems
    {
        private string Title { get; set; }
        public bool IsDeleted { get; set; }
        
        public int Id { get; set; }
        public string Name { get; set; }
        public RenderFragment OverwriteRowRender(string rowName)
        {
            throw new NotImplementedException();
        }
        public static ProfileItemsViewModel FromDto(StaffDto dto)
            => new()
            {
                Id = dto.Id,
                Name = dto.Name,
                Title = dto.Title,
                IsDeleted = dto.IsDeleted
            };
    }
}