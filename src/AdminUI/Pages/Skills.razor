@page "/Skills"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using SSW.Rewards.Admin.UI.Components.Dialogs.Confirmations
@using SSW.Rewards.Admin.UI.Components
@using SSW.Rewards.Shared.DTOs.Skills
@using SSW.Rewards.Shared.Services

@attribute [Authorize]

@inject ISkillsService skillsService
@inject ISkillsAdminService skillsAdminService
@inject ISnackbar Snackbar
@inject IDialogService DialogService


<MudText Typo="Typo.h2">Skills</MudText>
<MudText Typo="Typo.body1">All Staff Skills</MudText>

<MudTable Items="@_model.OrderBy(s => s.Name)"
          T="SkillDto"
          CanCancelEdit="true"
          Filter="new Func<SkillDto, bool>(FilterItemsFunc)"
          @bind-SelectedItem="@selectedItem"
          CommitEditTooltip="Commit Edit"
          OnCommitEditClick="OnEditSubmit">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Staff Skills</MudText>
        <MudSpacer/>
        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Delete"><MudButton OnClick="@(() => OnDeletedClicked(context))">Delete</MudButton></MudTd>
    </RowTemplate>
    <RowEditingTemplate>
        <MudTd DataLabel="Name">
            <MudTextField @bind-Value="@context.Name" Required/>
        </MudTd>
    </RowEditingTemplate>
    <PagerContent>
        <MudTablePager/>
    </PagerContent>
</MudTable>

<FabContainer>
    <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@((e) => OpenDialog(disableBackdropClick))"/>
</FabContainer>

@* TODO: Implement Deleting Skills *@
@code {
    private DialogOptions disableBackdropClick = new() { DisableBackdropClick = true };
    private string searchString = string.Empty;
    private SkillDto? selectedItem;
    private IEnumerable<SkillDto> _model { get; set; } = Enumerable.Empty<SkillDto>();


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        try
        {
            await GetSkills();
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    private async Task GetSkills()
    {
        _model = (await skillsService.GetSkillsList(CancellationToken.None)).Skills;
    }

    private async Task OpenDialog(DialogOptions options)
    {
        var dialog = DialogService.Show<SSW.Rewards.Admin.UI.Components.Dialogs.Skills.AddSkillDialog>("Create a Skill", options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            // Add the Skill
            if (result.Data is string skill)
            {
                await skillsAdminService.AddOrUpdateSkill(selectedItem, CancellationToken.None);
            }
            await GetSkills();
        }
    }

    private bool FilterItemsFunc(SkillDto item) => FilterFunc(item, searchString);

    //! Note: This is only filtering on the name
    private bool FilterFunc(SkillDto item, string searchString)
    {
        return string.IsNullOrWhiteSpace(searchString) || item.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase);
    }

    private async Task OnEditSubmit()
    {
        Snackbar.Clear();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;

        try
        {
            await skillsAdminService.AddOrUpdateSkill(selectedItem, CancellationToken.None);
            Snackbar.Add("Updated Skill!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Error Saving", Severity.Error);
        }
    }

    private async Task OnDeletedClicked(SkillDto item)
    {
        var result = await DialogService.Show<SimpleConfirmationDialog>(
            $"Delete \"{item.Name}?\"",
            SimpleConfirmationDialog.CreateDialogParams(
                SimpleConfirmationDialogType.Danger,
                "Deleting will remove this skill from all users")
            ).Result;

        if (!result.Canceled && (bool) result.Data)
        {
            await skillsAdminService.DeleteSkill(item.Id, CancellationToken.None);
            await GetSkills();
        }
        
    }
    

}